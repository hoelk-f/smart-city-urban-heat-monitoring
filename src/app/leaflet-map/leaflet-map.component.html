<div class="map-shell">
  <div id="map"></div>

  <button class="panel-toggle" (click)="togglePanel()" aria-label="Toggle info panel">
    <i class="fa-solid fa-circle-info"></i>
  </button>

  <div class="hover-info" *ngIf="activeRegion.visible">
    <div class="hover-info-name">{{ activeRegion.name }}</div>
    <div class="hover-info-meta">
      <span>{{ activeRegion.temperatureLabel }}</span>
      <span>&bull;</span>
      <span>{{ activeRegion.count }} sensors</span>
    </div>
  </div>

  <aside class="info-panel" [class.open]="panelOpen">
    <div class="panel-header">
      <div>
        <div class="panel-title">Urban Heat Monitoring</div>
        <div class="panel-subtitle">Live overview & data sources</div>
      </div>
      <div class="panel-header-actions">
        <button class="panel-close" (click)="togglePanel()" aria-label="Close panel">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">Overview</div>
      <div class="stat-grid">
        <div class="stat-card">
          <span>Average temperature</span>
          <strong>{{ averageTemperature.toFixed(2) }} &deg;C</strong>
        </div>
        <div class="stat-card">
          <span>Weather report</span>
          <strong>{{ weatherReportTemp.toFixed(2) }} &deg;C</strong>
        </div>
        <div class="stat-card">
          <span>Active sensors</span>
          <strong>{{ activeSensorCount }} / {{ temperatureData.length }}</strong>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">Integrated Public temp.json Sources</div>
      <button class="action-btn" (click)="openSourceModal()">
        <i class="fa-solid fa-plus"></i>
        Add data source
      </button>

      <div class="integrated-list" *ngIf="integratedSources.length > 0; else noSourcesIntegrated">
        <div class="integrated-item" *ngFor="let item of integratedSources">
          <div>
            <div class="integrated-title">{{ item.title }}</div>
            <div class="integrated-meta">{{ item.accessUrl }}</div>
          </div>
          <button class="trash-btn" (click)="removeIntegratedSource(item.key)" title="Remove source">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
      <ng-template #noSourcesIntegrated>
        <div class="source-footnote">No additional public data source integrated yet.</div>
      </ng-template>

      <div class="error-text" *ngIf="requestError">{{ requestError }}</div>
    </div>

    <div class="panel-section">
      <div class="section-title">Integrated base sources</div>
      <div class="source-block">
        <div class="source-title">GeoJSON</div>
        <a class="source-item" [href]="dataSources.geojson" target="_blank" rel="noopener">{{ dataSources.geojson }}</a>
      </div>
      <div class="source-block">
        <div class="source-title">Sensor feeds</div>
        <div class="source-list">
          <a class="source-item" *ngFor="let source of dataSources.sensors" [href]="source" target="_blank" rel="noopener">
            {{ source }}
          </a>
        </div>
      </div>
    </div>

    <div class="panel-section">
      <div class="section-title">Legends</div>
      <div class="legend-block">
        <div class="legend-title">Temperature deviation (border)</div>
        <div class="legend-items">
          <div class="legend-item" *ngFor="let entry of deviationLegend">
            <span class="legend-dot" [style.background]="entry.color"></span>
            <span>{{ entry.label }}</span>
          </div>
        </div>
      </div>
      <div class="legend-block">
        <div class="legend-title">Temperature (area)</div>
        <div class="legend-items">
          <div class="legend-item" *ngFor="let entry of areaLegend">
            <span class="legend-dot" [style.background]="entry.color"></span>
            <span>{{ entry.label }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel-section logos">
      <img src="assets/images/Icon_GesundesTal.png" alt="Gesundes Tal Logo" />
      <img src="assets/images/KFW.svg" alt="KFW Logo" />
      <img src="assets/images/BMWSB.png" alt="BMWSB Logo" />
    </div>
  </aside>

  <div class="source-modal-backdrop" *ngIf="sourceModalOpen" (click)="closeSourceModal()"></div>
  <div class="source-modal" *ngIf="sourceModalOpen">
    <div class="source-modal-header">
      <div>
        <h3>Integrate data sources</h3>
      </div>
      <button class="panel-close" (click)="closeSourceModal()" aria-label="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="source-modal-body">
      <div class="loading-text" *ngIf="sourceLoading">Loading sources...</div>
      <div class="error-text" *ngIf="sourceError">{{ sourceError }}</div>

      <div class="source-column" *ngIf="!sourceLoading">
        <h4>Public - {{ publicSources.length }}</h4>
        <div class="source-entry" *ngFor="let source of publicSources">
          <div class="source-entry-content">
            <div class="source-entry-title">{{ source.title }}</div>
            <div class="source-entry-meta">{{ source.accessUrl }}</div>
          </div>
          <button class="source-action" [disabled]="isSourceIntegrated(source.key)" (click)="integratePublicSource(source)">
            {{ isSourceIntegrated(source.key) ? 'Integrated' : 'Integrate' }}
          </button>
        </div>
        <div class="source-footnote" *ngIf="publicSources.length === 0">
          No public source with *temp* in title found.
        </div>
      </div>

      <div class="source-column" *ngIf="!sourceLoading">
        <h4>Restricted - {{ restrictedSources.length }}</h4>
        <div class="source-entry" *ngFor="let source of restrictedSources">
          <div class="source-entry-content">
            <div class="source-entry-title">{{ source.title }}</div>
            <div class="source-entry-meta">{{ source.accessUrl }}</div>
          </div>
          <button class="source-action" [disabled]="isRestrictedRequested(source.key)" (click)="requestRestrictedSource(source)">
            {{ isRestrictedRequested(source.key) ? 'Requested' : 'Request access' }}
          </button>
        </div>
        <div class="source-footnote" *ngIf="restrictedSources.length === 0">
          No restricted source with *temp* in title found.
        </div>
      </div>
    </div>
  </div>
</div>
